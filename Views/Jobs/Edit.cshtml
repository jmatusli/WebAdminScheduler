@{
  ViewData["Title"] = "Edit";
}
<head>
  <link rel="stylesheet" href="~/css/datatables.min.css" />
  <link rel="stylesheet" href="~/lib/Toast/dist/jquery.toast.min.css" />
  <link rel="stylesheet" href="~/lib/SweetAlert/dist/sweetalert2.min.css" />
  <script src="~/js/jquery-1.11.3.min.js"></script>
  <script src="~/js/pdfmake.min.js"></script>
  <script src="~/js/vfs_fonts.js"></script>
  <script src="~/js/datatables.min.js"></script>
  <script src="~/lib/SweetAlert/dist/sweetalert2.min.js"></script>
  <script src="~/lib/Toast/dist/jquery.toast.min.js"></script>
</head>

<h1>Editar Jobs</h1>
<br />
<div class="card">
  <div class="card-header">
    <a id="btnSaveJobs" onclick="GuardarJobs()" class="btn btn-primary">Guardar</a>
  </div>
  <div class="card-body">
    <div class="row g-4 align-items-center">
      <div class="col-auto">
        <label for="TittleProc" class="col-form-label">IDPROC</label>
      </div>
      <div class="col-auto">
        <label for="txtIdProc" class="col-form-label">@Model.IDPROC</label>
      </div>
      <div class="col-auto">
        <label for="TittleConex" class="col-form-label">IDCONEX</label>
      </div>
      <div class="col-auto">
        <input type="number" min="1" class="form-control" data-placement="right" data-align="top" data-autoclose="true" id="IdUptConex" name="IdUptConex">
      </div>
    </div>
    <br />

    <div class="container">
      <div class="row">
        <div class="col-auto">
          <label for="TittleNombre" class="col-form-label">NOMBRE</label>
        </div>
        <div class="col-6">
          <input type="text" min="1" class="form-control" data-placement="right" data-align="top" data-autoclose="true" id="txtUptNombre" name="txtUptNombre">
        </div>
      </div>
    </div>
    <br />

    <div class="container">
      <div class="row">
        <div class="col-auto">
          <label for="TittleDescrpcion" class="col-form-label">DESCRIPCIÃ“N</label>
        </div>
        <div class="col-6">
          <input type="text" min="1" class="form-control" data-placement="right" data-align="top" data-autoclose="true" id="txtUptDescripcion" name="txtUptDescripcion">
        </div>
      </div>
    </div>
    <br />

    <div class="container">
      <div class="row">
        <div class="col-auto">
          <label for="TittlePath" class="col-form-label">PATH</label>
        </div>
        <div class="col-6">
          <input type="text" min="1" class="form-control" data-placement="right" data-align="top" data-autoclose="true" id="txtUptPath" name="txtUptPath">
        </div>
      </div>
    </div>
    <br />

    <div class="container">
      <div class="row">
        <div class="col-auto">
          <label for="TittleParametro1" class="col-form-label">PARAMETRO1</label>
        </div>
        <div class="col-6">
          <input type="text" min="1" class="form-control" data-placement="right" data-align="top" data-autoclose="true" id="txtUptParametro1" name="txtUptParametro1">
        </div>
      </div>
    </div>
    <br />

    <div class="container">
      <div class="row">
        <div class="col-auto">
          <label for="TittleParametroDos" class="col-form-label">PARAMETRO2</label>
        </div>
        <div class="col-6">
          <input type="text" min="1" class="form-control" data-placement="right" data-align="top" data-autoclose="true" id="txtUptParametro2" name="txtUptParametro2">
        </div>
      </div>
    </div>
    <br />

    <div class="container">
      <div class="row">
        <div class="col-auto">
          <label for="TittleParametroTres" class="col-form-label">PARAMETRO3</label>
        </div>
        <div class="col-6">
          <input type="text" min="1" class="form-control" data-placement="right" data-align="top" data-autoclose="true" id="txtUptParametro3" name="txtParametro3">
        </div>
      </div>
    </div>
    <br />

    <div class="container">
      <div class="row">
        <div class="col-auto">
          <label for="TittleParametroCuatro" class="col-form-label">PARAMETRO4</label>
        </div>
        <div class="col-6">
          <input type="text" min="1" class="form-control" data-placement="right" data-align="top" data-autoclose="true" id="txtUptParametro4" name="txtUptParametro4">
        </div>
      </div>
    </div>
    <br />

    <div class="row g-4 align-items-center">
      <div class="col-auto">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="" id="checkUptDependencia" name="checkUptDependencia">
            <label class="form-check-label" for="IdDependencia">
              DEPENDENCIA
            </label>
        </div>
      </div>
      <div class="col-auto">
        <label class="form-check-label" for="lblIntentos">
          INTENTOS
        </label>
    </div>
    <div class="col-auto">
      <input type="number" min="1" class="form-control" data-placement="right" data-align="top" data-autoclose="true" id="txtUptIntentos" name="txtUptIntentos">
    </div>
    <div class="col-auto">
      <label class="form-check-label" for="lblEsperaIntento">
        ESPERA INTENTO
      </label>
    </div>
    <div class="col-auto">
      <input type="number" min="1" class="form-control" data-placement="right" data-align="top" data-autoclose="true" id="txtUptEsperaIntento" name="txtUptEsperaIntento">
    </div>
    <div class="col-auto">
      <label class="form-check-label" for="lblEstado">
        ESTADO
      </label>
    </div>
      <div class="col-auto">
        <select class="form-select" name="txtUptEstado" id="txtUptEstado">
          <option value="Activo">ACTIVO</option>
          <option value="Inactivo">INACTIVO</option>
          <option value="Internal">INTERNAL</option>
        </select>
      </div>
      <div class="col-auto">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="" id="flexUptCheckFtp">
          <label class="form-check-label" for="lblFtp">
            FTP
          </label>
        </div>
      </div>
      <div class="col-auto">
        <label class="form-check-label" for="lblIdHost">
          IDHOST
        </label>
      </div>
      <div class="col-auto">
        <input type="number" min="1" class="form-control" data-placement="right" data-align="top" data-autoclose="true" id="txtUptIdHost" name="txtUptIdHost">
      </div>
      <div class="col-auto">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="" id="flexCheckUptCompresion" name="flexCheckUptCompresion">
          <label class="form-check-label" for="lblflexCheckComprension">
            COMPRESION
          </label>
        </div>
      </div>
      <div class="col-auto">
        <label class="form-check-label" for="lblNode">
          NODE
        </label>
      </div>
      <div class="col-auto">
        <input type="text" min="1" class="form-control" data-placement="right" data-align="top" data-autoclose="true" id="txtUptNode" name="txtUptNode">
      </div>
    </div>
  </div>
  <div class="card-footer text-muted">
    <h4 style="text-align: center;">Editar crontab asociado</h4>
  </div>
</div>

<div class="container">
  <table id="dt-crontab" class="display nowrap" width="100%">
    <thead>
      <tr>
        <th><input type="checkbox" name="select_all" class="dt-column-title" value="1" id="dt-crontab-select-all-th"></th>
        <th style="font-size:13px;">IDCRONTAB</th>
        <th style="font-size:13px;">HORA INICIO</th>
        <th style="font-size:13px;">HORA FIN</th>
        <th style="font-size:13px;">DAYS</th>
        <th style="font-size:13px;">DAY EXE</th>
        <th style="font-size:13px;">MONTHS</th>
        <th style="font-size:13px;">REPEAT EVERY MINS</th>
        <th style="font-size:13px;">REPEAT AFTER FINISH</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>

<script> 
  var params={};
  var table={};
  var idjob="";

  var idproc="@Model.IDPROC";
  params.idproc=idproc;

  var id_conex = "@Model.IDCONEX";
  var nombre = "@Model.NOMBRE";
  var descripcion = "@Model.DESCRIPCION";
  var path = "@Model.PATH";
  var param1 = "@Model.PARAMETRO1";
  var param2 = "@Model.PARAMETRO2";
  var param3 = "@Model.PARAMETRO3";
  var param4 = "@Model.PARAMETRO4";
  var dependencia = "@Model.DEPENDENCIA";
  var intentos = "@Model.INTENTOS";
  var espera_intento = "@Model.ESPERA_INTENTO";
  var estado = "@Model.ESTADO";
  var ftp = "@Model.FTP";
  var id_host = "@Model.IDHOST";
  var compresion = "@Model.COMPRESION";
  var node = "@Model.NODE";
  var idcrontab="@Model.IDCRONTAB";
 
  $(document).ready( function () {
    $("#IdUptConex").val(id_conex);
    $("#txtUptNombre").val(nombre);
    $("#txtUptDescripcion").val(descripcion);
    $("#txtUptPath").val(path);
    $("#txtUptParametro1").val(param1);
    $("#txtUptParametro2").val(param2);
    $("#txtUptParametro3").val(param3);
    $("#txtUptParametro4").val(param4);

    if(dependencia == 1) {
      $("#checkUptDependencia").prop('checked', true);
    } else {
      $("#checkUptDependencia").prop('checked', false);
    }

    $("#txtUptIntentos").val(intentos);
    $("#txtUptEsperaIntento").val(espera_intento);
    $("#txtUptEstado").val(estado);

    $("#txtUptNode").val(node);

    if(ftp == 1) {
      $("#flexUptCheckFtp").prop('checked', true);
    } else {
      $("#flexUptCheckFtp").prop('checked', false);
    }

    $("#txtUptIdHost").val(id_host);

    if(compresion == 1) {
      $("#flexCheckUptCompresion").prop('checked', true);
    } else {
      $("#flexCheckUptCompresion").prop('checked', false);
    }

    var table = $('#dt-crontab').DataTable( {
      "processing": true,
      "serverSide": true,
      "paging": true,
	    "deferLoading": 0, // here
      "scrollX":          true,
      "sScrollX":         "50%",
      "scrollY":            $(document).height() - 300,
      "scrollCollapse":     true,
      "ajax": {
        "url": "@Url.Action("ListarCrontabs","Calendario")",
        "type": "POST",
        "datatype": "json",
		    "data": function(d){
          $.extend( d, params);    
        }
      },
      drawCallback: function(settings){ 
        if($(this).find('tbody tr').length <= 1){
        $('.dt-paging-button').hide();
      }
    },rowCallback: function (row, data) {
      if (data.idcrontab == idcrontab) {
        table.row(row).select()
      }  
    },
    "columnDefs": [{
      'targets': 0,
    orderable: false
    },{
    'targets': -1,
    orderable: false,
      'render': function (data, type, full, meta) {
        return   '';
      }
    }],
    "columns": [
      {
        "render": function (data,row) { return '<input type="radio" name="select_all" class="dt-column-title" value="1" id="dt-crontab-select-item">';   }
      },
      { "data": "idcrontab", "name": "idcrontab", "autoWidth": true },
        { "data": "horA_INICIO", "name": "horA_INICIO", "autoWidth": true },
        { "data": "horA_FIN", "name": "horA_FIN", "autoWidth": true },
        { "data": "wdaY_M2S_EX", "name": "wdaY_M2S_EX", "autoWidth": true },
        { "data": "daY_EX", "name": "daY_EX", "autoWidth": true },
        { "data": "montH_EX", "name": "montH_EX", "autoWidth": true },
        { "data": "repeaT_EVERY_MINS", "name": "repeaT_EVERY_MINS", "autoWidth": true },
        { "data": "repeaT_AFTER_FINISH", "name": "repeaT_AFTER_FINISH", "autoWidth": true },
      ],
      select: {
      style: 'single',
      selector: 'td:not(:last-child)' // no row selection on last column
      },
      "language": {
      "url": "/lib/datatables/dist/locales/es/es.json"
      }
    });

    table.on('select', function (e, dt, type, indexes) {
      if (type === 'row'   ) {
        var nodes = table
        .rows(indexes)
        .nodes()
        .each(function () { 
          $('td:first-child', this).find('input').prop('checked', true);
        });
        selectedCrontab=table.rows( { selected: true }).data()[0].idcrontab;
        console.log("selectedCrontab ", selectedCrontab)
      }
    });

    table.on('deselect', function (e, dt, type, indexes) {
      if (type === 'row') {
      $('#dt-crontab-select-all').prop("checked",false);
        table
        .rows(indexes)
        .nodes()
        .each(function () { 
          $('td:first-child', this).find('input').prop('checked', false); 
        });
      }
       selectedCrontab=0;
    });
    
    // Handle click on "Select all" control
    $('#dt-crontab-select-all-th').on('click', function() {
      if(table.settings()[0]._select.style=='multi')
      { 
        // Get all rows with search applied
        var rows = table.rows({ 'search': 'applied' }).nodes();
        // Check/uncheck checkboxes for all rows in the table
        if(this.checked) {
          $('input[type="checkbox"]', rows).prop('checked', this.checked);
          var selData =   table.rows().select();
          var selData =   table.rows(".selected").data();
        }
        else 
        {
          var selData =   table.rows().deselect();
        }
      }
      else 
      return false;
    });

    // Handle click on checkbox to set state of "Select all" control
    $('#dt-crontab tbody').on('change', 'input[type="checkbox"]', function(){
      // If checkbox is not checked
        if(!this.checked){
        var el = $('#dt-crontab-select').get(0);
        // If "Select all" control is checked and has 'indeterminate' property
        if(el && el.checked && ('indeterminate' in el)){
          // Set visual state of "Select all" control
          // as 'indeterminate'
          el.indeterminate = true;
        }
      }
    });

 

  });

  function GuardarJobs() {
    id_conex = $('#IdUptConex').val();
    nombre = $('#txtUptNombre').val();
    descripcion = $('#txtUptDescripcion').val();
    path = $('#txtUptPath').val();
    param1 = $('#txtUptParametro1').val();
    param2 = $('#txtUptParametro2').val();
    param3 = $('#txtUptParametro3').val();
    param4 = $('#txtUptParametro4').val();
    intentos = $('#txtUptIntentos').val();
    espera_intento = $('#txtUptEsperaIntento').val();
    estado = $('#txtUptEstado').val();
    id_host = $('#txtUptIdHost').val();
    node = $('#txtUptNode').val();

    var data_job={
      "oProcesos" : {
      "IDPROC" : idproc,
      "IDCONEX": id_conex,
      "NOMBRE" : nombre,
      "DESCRIPCION" : descripcion,
      "PATH" : path,
      "PARAMETRO1" : param1,
      "PARAMETRO2" : param2,
      "PARAMETRO3" : param3,
      "PARAMETRO4" : param4,
      "DEPENDENCIA" : $('#checkUptDependencia').is(":checked") ? 1 : 0,
      "INTENTOS" : intentos,
      "ESPERA_INTENTO" : parseInt(espera_intento,10),
      "ESTADO" : estado,
      "FTP" : $('#flexUptCheckFtp').is(":checked") ? 1 : 0,
      "IDHOST" : parseInt(id_host,10),
      "COMPRESION" : $('#flexCheckUptCompresion').is(":checked") ? 1 : 0,
      "IDCRONTAB" : selectedCrontab,
      "NODE" : node
    }
  };
console.log("esto va ",data_job)
  if (idproc != 0) {
    jQuery.ajax({
    method: "POST",
    async: true,
    dataType: "json",
    data: JSON.stringify(data_job),
    contentType: "application/json; charset=utf-8",
    url: "@Url.Action("Update","Jobs")",

    success: function (data) {
      
      if(data.error)
      {
      Swal.fire ('Duplicidad...', data.msg, 'error')

      }
      else
      Swal.fire({
        title: "Jobs Actualizado!",
        text: "Click en aceptar para ver los procesos!",
        icon: "success",
        confirmButtonText: "Aceptar",
      }).then((result) => {
      if (result.isConfirmed) {
        $(location).attr("href","@Url.Action("Index","Jobs")")
      }  
    });
  }
});
} else {
  $("#IdUptConex").val("");
  $("#txtUptNombre").val("");
  $("#txtUptDescripcion").val("");
  $("#txtUptPath").val("");
  $("#txtUptParametro1").val("");
  $("#txtUptParametro2").val("");
  $("#txtUptParametro3").val("");
  $("#txtUptParametro4").val("");
  $("#txtUptIntentos").val("");
  $("#txtUptEsperaIntento").val("");
  $("#txtUptIdHost").val("");
  $("#txtUptNode").val("");
}
}
</script>