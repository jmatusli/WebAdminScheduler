@model WebAdminScheduler.Models.CP_CRONTAB;
@{  
  ViewData["Title"] = "Crear";  
}
<head>
  <link rel="stylesheet" href="~/css/datatables.min.css" />
  <link rel="stylesheet" href="~/lib/Toast/dist/jquery.toast.min.css" />
  <link rel="stylesheet" href="~/lib/SweetAlert/dist/sweetalert2.min.css" />
  <script src="~/js/jquery-1.11.3.min.js"></script>
  <script src="~/js/pdfmake.min.js"></script>
  <script src="~/js/vfs_fonts.js"></script>
  <script src="~/js/datatables.min.js"></script>
  <script src="~/lib/SweetAlert/dist/sweetalert2.min.js"></script>
  <script src="~/lib/Toast/dist/jquery.toast.min.js"></script>
</head>
    
<h1>@ViewData["Title"]Jobs</h1>
<div class="card">
  <div class="card-header">
    <a  id="saveJob" class="btn btn-primary">Guardar</a>
  </div>
  <div class="card-body">
    <div class="row g-4 align-items-center">
      <div class="col-auto">
        <label for="TittleConex" class="col-form-label">IDCONEX</label>
      </div>
      <div class="col-auto">
        <input type="number" min="1" class="form-control clockpicker" data-placement="right" data-align="top" data-autoclose="true">
      </div>
      <div class="col-auto">
        <label for="TittleNombre" class="col-form-label">NOMBRE</label>
      </div>
      <div class="col-auto">
        <input type="text" min="1" class="form-control clockpicker" data-placement="right" data-align="top" data-autoclose="true">
      </div>
      <div class="col-auto">
        <label for="TittleDescrpcion" class="col-form-label">DESCRIPCIÓN</label>
      </div>
      <div class="col-auto">
        <input type="text" min="1" class="form-control clockpicker" data-placement="right" data-align="top" data-autoclose="true">
      </div>
    </div>

    <br/>
    <div class="row g-4 align-items-center">
      <div class="col-auto">
        <label for="TittlePath" class="col-form-label">PATH</label>
      </div>
      <div class="col-auto">
        <input type="text" min="1" class="form-control clockpicker" data-placement="right" data-align="top" data-autoclose="true">
      </div>
      <div class="col-auto">
        <label for="TittleParametro1" class="col-form-label">PARAMETRO1</label>
      </div>
      <div class="col-auto">
          <input type="text" min="1" class="form-control clockpicker" data-placement="right" data-align="top" data-autoclose="true">
      </div>
      <div class="col-auto">
        <label for="TittleParametroDos" class="col-form-label">PARAMETRO2</label>
      </div>
      <div class="col-auto">
        <input type="text" min="1" class="form-control clockpicker" data-placement="right" data-align="top" data-autoclose="true">
      </div>
      <div class="col-auto">
        <label for="TittleParametroTres" class="col-form-label">PARAMETRO3</label>
      </div>
      <div class="col-auto">
        <input type="text" min="1" class="form-control clockpicker" data-placement="right" data-align="top" data-autoclose="true">
      </div>
      <div class="col-auto">
        <label for="TittleParametroCuatro" class="col-form-label">PARAMETRO4</label>
      </div>
      <div class="col-auto">
        <input type="text" min="1" class="form-control clockpicker" data-placement="right" data-align="top" data-autoclose="true">
      </div>
      <div class="col-auto">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="" id="IdDependencia">
          <label class="form-check-label" for="IdDependencia">
            DEPENDENCIA
          </label>
        </div>
      </div>
    </div>

    <br/>
    <div class="row g-4 align-items-center">
      <div class="col-auto">
        <span id="RepeatIntentos" class="form-text">
          INTENTOS
        </span>
      </div>
      <div class="col-auto">
        <input type="number" min="1" class="form-control clockpicker" data-placement="right" data-align="top" data-autoclose="true">
      </div>
      <div class="col-auto">
        <span id="RepeatEsperaIntento" class="form-text">
          ESPERA INTENTO
        </span>
      </div>
      <div class="col-auto">
        <input type="number" min="1" class="form-control clockpicker" data-placement="right" data-align="top" data-autoclose="true">
      </div>
      <div class="col-auto">
        <span id="RepeatEstado" class="form-text">
          ESTADO
        </span>
      </div>
      <div class="col-auto">
        <select class="form-select" name="estado" id="estado">
          <option value="act">ACTIVO</option>
          <option value="inact">INACTIVO</option>
          <option value="int">INTERNAL</option>
        </select>
      </div>
      <div class="col-auto">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="" id="flexCheckFtp">
          <label class="form-check-label" for="flexCheckFtp">
            FTP
          </label>
        </div>
      </div>
    </div>
    <br/>
    <div class="row g-4 align-items-center">
      <div class="col-auto">
        <span id="idHost" class="form-text">
          IDHOST
        </span>
      </div>
      <div class="col-auto">
        <input type="number" min="1" class="form-control clockpicker" data-placement="right" data-align="top" data-autoclose="true">
      </div>
      <div class="col-auto">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="" id="flexCheckComprension">
          <label class="form-check-label" for="flexCheckComprension">
            COMPRESIÓN
          </label>
        </div>
      </div>
      <div class="col-auto">
        <span id="Node" class="form-text">
          NODE
        </span>
      </div>
      <div class="col-auto">
        <input type="number" min="1" class="form-control clockpicker" data-placement="right" data-align="top" data-autoclose="true">
      </div>
    </div>
  </div>
  <div class="card-footer text-muted">
    <h4 style="text-align: center;">Registrar Crontab</h4>
  </div>
</div>

<div class="container">
  <table id="dt-crontab" class="display nowrap" width="100%">
    <thead>
      <tr>
        <th><input type="checkbox" name="select_all" class="dt-column-title" value="1" id="dt-crontab-select-all-th"></th>
        <th>IDCRONTAB</th>
        <th>HORA INICIO</th>
        <th>HORA FIN</th>
        <th>DAYS</th>
        <th>DAY EXE</th>
        <th>MONTHS</th>
        <th>REPEAT EVERY MINS</th>
        <th>REPEAT AFTER FINISH</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>

<script>

  var params={}, selectedCrontab = 0;
 
  function recargartabla(objeto,value)
  {
    params.estado=value;
    objeto.ajax.reload(null,false); //reload datatable ajax 
  }

  $(document).ready( function () {

    var table = $('#dt-crontab').DataTable( {
      "processing": true,
      "serverSide": true,
      "paging": true,
	    "deferLoading": 0, // here
      "scrollX":          true,
      "sScrollX":         "50%",
      "scrollY":            $(document).height() - 300,
      "scrollCollapse":     true,
      "ajax": {
        "url": "@Url.Action("ListarCrontabs","Calendario")",
        "type": "POST",
        "datatype": "json",
		    "data": function(d){
          $.extend( d, params);    
        }
      },
      drawCallback: function(settings){ 
        if($(this).find('tbody tr').length <= 1){
        $('.dt-paging-button').hide();
      }
    },drawCallback: function(settings){ 
			  if($(this).find('tbody tr').length <= 1){
			  $('.dt-paging-button').hide();
			}
		},
      "columnDefs": [{
        'targets': 0,
      orderable: false 
          
      },{
      'targets': -1,
      orderable: false,
        'render': function (data, type, full, meta) {
          return   '';
        }
      }],
      "columns": [
        {
          "render": function (data,row) { return '<input type="radio" name="select_all" class="dt-column-title" value="1" id="dt-crontab-select-item">';   }
        },
        { "data": "idcrontab", "name": "idcrontab", "autoWidth": true },
          { "data": "horA_INICIO", "name": "horA_INICIO", "autoWidth": true },
          { "data": "horA_FIN", "name": "horA_FIN", "autoWidth": true },
          { "data": "wdaY_M2S_EX", "name": "wdaY_M2S_EX", "autoWidth": true },
          { "data": "daY_EX", "name": "daY_EX", "autoWidth": true },
          { "data": "montH_EX", "name": "montH_EX", "autoWidth": true },
          { "data": "repeaT_EVERY_MINS", "name": "repeaT_EVERY_MINS", "autoWidth": true },
          { "data": "repeaT_AFTER_FINISH", "name": "repeaT_AFTER_FINISH", "autoWidth": true },
      ],
    
    select: {
    style: 'single',
    selector: 'td:not(:last-child)' // no row selection on last column
    },
      "language": {
      "url": "/lib/datatables/dist/locales/es/es.json"
      }
    });

    table.on('select', function (e, dt, type, indexes) {
    
      if (type === 'row'   ) {
        var nodes = table
        .rows(indexes)
        .nodes()
        .each(function () { 
          $('td:first-child', this).find('input').prop('checked', true);
        });
        selectedCrontab=table.rows( { selected: true }).data()[0].idcrontab;
        console.log("selectedCrontab ", selectedCrontab)
      }
    });

    table.on('deselect', function (e, dt, type, indexes) {
      if (type === 'row') {
      $('#dt-crontab-select-all').prop("checked",false);
        table
        .rows(indexes)
        .nodes()
        .each(function () { 
          $('td:first-child', this).find('input').prop('checked', false); 
        });
      }
    });
    
    // Handle click on "Select all" control
    $('#dt-crontab-select-all-th').on('click', function() {
      if(table.settings()[0]._select.style=='multi')
      { 
      // Get all rows with search applied
      var rows = table.rows({ 'search': 'applied' }).nodes();
      // Check/uncheck checkboxes for all rows in the table
      if(this.checked){
        $('input[type="checkbox"]', rows).prop('checked', this.checked);
        
        var selData =   table.rows().select();
        var selData =   table.rows(".selected").data();
      }
      else 
      {
        var selData =   table.rows().deselect();
      }

      }
      else 
      return false;
    });

    // Handle click on checkbox to set state of "Select all" control
    $('#dt-crontab tbody').on('change', 'input[type="checkbox"]', function(){
      // If checkbox is not checked
        if(!this.checked){
        var el = $('#dt-crontab-select').get(0);
        // If "Select all" control is checked and has 'indeterminate' property
        if(el && el.checked && ('indeterminate' in el)){
          // Set visual state of "Select all" control
          // as 'indeterminate'
          el.indeterminate = true;
        }
      }
    });

    $("#saveJob").on("click",function(){
      var data_job={
        "oProcesos":{
          "IDPROC":"0",
          "IDCONEX":1,
          "NOMBRE":"TEST PROC "+(1 + Math.floor(Math.random() * 6)),
          "DESCRIPCION":"DESCRIPCION PROC",
          "PATH":"PATH PROC",
          "PARAMETRO1":"TEST PARAMETRO1",
          "PARAMETRO2":"TEST PARAMETRO2",
          "PARAMETRO3":"TEST PARAMETRO3",
          "PARAMETRO4":"TEST PARAMETRO4",
          "DEPENDENCIA":1,
          "INTENTOS":1,
          "ESPERA_INTENTO":1,
          "ESTADO":"Activo",
          "FTP":0,
          "IDHOST":0,
          "COMPRESION":0,
          "IDCRONTAB":selectedCrontab,
          "NODE":"TEST NODE"
        }
      };
 
    $.ajax({
      method: "POST",
      async: true,
      dataType: "json",
      data: JSON.stringify(data_job),
      contentType: "application/json; charset=utf-8",
      url: '@Url.Action("Save", "Jobs")' ,
      success: function () {
        Swal.fire({
        title: "Job registrado!",
        text: "Click en aceptar para ver jobs registrados!",
        icon: "success",
        confirmButtonText: "Aceptar",
      }).then((result) => {
        if (result.isConfirmed) {
          $(location).attr("href","@Url.Action("Index","Jobs")")
        }  
    });
  },
    error: function () {
      alert("Error while inserting data");
    }
});
})      
});
</script> 